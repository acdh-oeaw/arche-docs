<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Pretty extensive tour through the ARCHE Suite deployment | ARCHE Suite documentation</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Pretty extensive tour through the ARCHE Suite deployment" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Documentation for the ARCHE repository software stack" />
<meta property="og:description" content="Documentation for the ARCHE repository software stack" />
<link rel="canonical" href="/arche-docs/aux/firstSteps.html" />
<meta property="og:url" content="/arche-docs/aux/firstSteps.html" />
<meta property="og:site_name" content="ARCHE Suite documentation" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pretty extensive tour through the ARCHE Suite deployment" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Documentation for the ARCHE repository software stack","headline":"Pretty extensive tour through the ARCHE Suite deployment","url":"/arche-docs/aux/firstSteps.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/arche-docs/assets/css/style.css?v=0bf3ea4828ec6a68b836c31eeafdb244ab6f7bce">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/arche-docs/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/arche-docs/">ARCHE Suite documentation</a></h1>

        

        <p>Documentation for the ARCHE repository software stack</p>

        
        <p class="view"><a href="https://github.com/acdh-oeaw/arche-docs">View the Project on GitHub <small>acdh-oeaw/arche-docs</small></a></p>
        

        

        
      </header>
      <section>

      <h1 id="pretty-extensive-tour-through-the-arche-suite-deployment">Pretty extensive tour through the ARCHE Suite deployment</h1>

<h2 id="table-of-contents">Table of contents</h2>

<ul>
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#really-quick-and-dirty-setup">Really quick and dirty setup</a></li>
  <li><a href="#step-by-step-installation">Step-by-step installation</a>
    <ul>
      <li><a href="#installing-arche-core">Installing arche-core</a></li>
      <li><a href="#troubleshooting">Troubleshooting</a></li>
      <li><a href="#deciding-on-metadata-schema">Deciding on metadata schema</a></li>
      <li><a href="#ingesting-some-data">Ingesting some data</a></li>
      <li><a href="#acess-control">Acess control</a></li>
      <li><a href="#setting-up-a-basic-oai-pmh">Setting up a basic OAI-PMH</a></li>
      <li><a href="#plugging-in-checks-on-the-data-ingestion">Plugging in checks on the data ingestion</a></li>
      <li><a href="#adding-pids-resolver-and-content-format-negotation">Adding PIDs resolver and content format negotation</a></li>
      <li><a href="#batch-updating-metadata">Batch-updating metadata</a></li>
    </ul>
  </li>
  <li><a href="#further-considerations">Further considerations</a></li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<p>You need:</p>

<ul>
  <li><a href="https://git-scm.com/">git</a></li>
  <li><a href="https://www.docker.com/">Docker</a></li>
  <li>any unformatted text editor</li>
  <li>ability to work with a command line</li>
  <li>a tool to make HTTP requests
(e.g. <a href="https://curl.se/">curl</a>, <a href="https://podman.io/">Podman</a>
or a web browser)</li>
</ul>

<p>Remarks:</p>

<ul>
  <li>This guide was tested on a linux (Ubuntu 22.04) machine.
    <ul>
      <li>As we are using Docker it should be also reproducible on a Windows and macOS machine
but this was not tested and there is a risk you will run into platform-specific issues.</li>
      <li>If you are using Windows, you may install Ubuntu as a virtual machine using the WSL.
See https://learn.microsoft.com/en-us/windows/wsl/install and
https://docs.docker.com/engine/install/ubuntu/ .</li>
      <li>If you are using Fedora/RedHat, then you may want to use Podman instead of Docker.
This should work in general but there might be some differences you will need to address
and which are not covered by this guide
(e.g. slightly different handling of mounting host directories as volumes or lack of the <em>compose</em> action).
For the most smooth experience I would advise you to install Docker.</li>
      <li>If you are using Fedora/RedHat with selinux turned on, you might need to add <code class="language-plaintext highlighter-rouge">--privileged</code> switch to
<code class="language-plaintext highlighter-rouge">docker run</code> commands (or <code class="language-plaintext highlighter-rouge">privileged: true</code> in the <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>).</li>
    </ul>
  </li>
  <li>We will be using Docker extensively.
If you have no experience with it at all, you may succeed with the <em>Really quick and dirty setup</em>
but it will be really difficult for you to go beyond it.
There are two solutions of this problem - either find someone who knows Docker
(it is quite a widespread technology nowadays so it should not be a trouble)
or read a little how it works on the internet.</li>
</ul>

<h2 id="really-quick-and-dirty-setup">Really quick and dirty setup</h2>

<p>In this step we will just set up an ARCHE Suite instance as it is used at the <a href="https://www.oeaw.ac.at/acdh/">ACDH-CH</a>.</p>

<p>It creates a fully-fledged setup with some optional services and also ingests some data into the repository.</p>

<ol>
  <li>Start it up with:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--name</span> arche-suite <span class="nt">-p</span> 80:80 <span class="nt">-e</span> <span class="nv">CFG_BRANCH</span><span class="o">=</span>arche <span class="nt">-e</span> <span class="nv">ADMIN_PSWD</span><span class="o">=</span><span class="s1">'myAdminPassword'</span> <span class="nt">-d</span> acdhch/arche
</code></pre></div>    </div>
  </li>
  <li>Run:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker logs <span class="nt">-f</span> arche-suite
</code></pre></div>    </div>
    <p>and wait until you see something like:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">##########</span>
<span class="c"># Starting supervisord</span>
<span class="c">##########</span>
   
2023-06-22 08:44:35,458 INFO Included extra file <span class="s2">"/home/www-data/config/supervisord.conf.d/postgresql.conf"</span> during parsing
2023-06-22 08:44:35,458 INFO Included extra file <span class="s2">"/home/www-data/config/supervisord.conf.d/tika.conf"</span> during parsing
2023-06-22 08:44:35,459 INFO RPC interface <span class="s1">'supervisor'</span> initialized
2023-06-22 08:44:35,459 CRIT Server <span class="s1">'unix_http_server'</span> running without any HTTP authentication checking
2023-06-22 08:44:35,459 INFO supervisord started with pid 1253
2023-06-22 08:44:36,462 INFO spawned: <span class="s1">'initScripts'</span> with pid 1255
2023-06-22 08:44:36,463 INFO spawned: <span class="s1">'apache2'</span> with pid 1256
2023-06-22 08:44:36,464 INFO spawned: <span class="s1">'postgresql'</span> with pid 1257
2023-06-22 08:44:36,464 INFO spawned: <span class="s1">'tika'</span> with pid 1258
2023-06-22 08:44:36,465 INFO spawned: <span class="s1">'txDaemon'</span> with pid 1259
2023-06-22 08:44:37,496 INFO success: initScripts entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
2023-06-22 08:44:37,496 INFO success: apache2 entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
2023-06-22 08:44:37,496 INFO success: postgresql entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
2023-06-22 08:44:37,496 INFO success: tika entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
2023-06-22 08:44:37,496 INFO success: txDaemon entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
</code></pre></div>    </div>
    <p>Now hit <code class="language-plaintext highlighter-rouge">CRTL+c</code>.<br />
At this point the repository is up and running.</p>
  </li>
  <li>Wait until initial data is imported.<br />
Run:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-u</span> www-data arche-suite <span class="nb">tail</span> <span class="nt">-f</span> log/initScripts.log
</code></pre></div>    </div>
    <p>and wait until you see (this may take a few minutes as two big controlled vocabularies are being imported):</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">##########</span>
<span class="c"># INIT SCRIPTS ENDED</span>
<span class="c">##########</span>
</code></pre></div>    </div>
  </li>
  <li>Import a sample collection with a resource:
    <ul>
      <li>Log into the docker container with:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-u</span> www-data arche-suite bash
</code></pre></div>        </div>
      </li>
      <li>Create a <code class="language-plaintext highlighter-rouge">collection.ttl</code> describing a top collection resource and a TEI-XML resource according to the <a href="https://github.com/acdh-oeaw/arche-schema">ACDH-CH metadata schema</a>:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'
@prefix n1: &lt;https://vocabs.acdh.oeaw.ac.at/schema#&gt;.

&lt;https://id.acdh.oeaw.ac.at/traveldigital&gt; a n1:TopCollection;
    n1:hasIdentifier &lt;https://hdl.handle.net/21.11115/0000-000C-29F3-4&gt;;
    n1:hasPid "https://hdl.handle.net/21.11115/0000-000C-29F3-4"^^&lt;http://www.w3.org/2001/XMLSchema#anyURI&gt;;
    n1:hasTitle "travel!digital Collection"@en;
    n1:hasDescription "A digital collection of early German travel guides on non-European countries which were released by the Baedeker publishing house between 1875 and 1914. The collection consists of the travel!digital Corpus (XML/TEI transcriptions of first editions (5 volumes) including structural, semantic and linguistic annotations), the travel!digital Facsimiles (scans and photographs of the historical prints), the travel!digital Auxiliary Files (a TEI schema of the annotations applied in the corpus, and a list of term labels for indexing names of persons annotated in the corpus), and the travel!digital Thesaurus (a SKOS vocabulary covering designations of groups and selected sights annotated in the corpus).\n The collection was created within the GO!DIGITAL 1.0 project \"travel!digital. Exploring People and Monuments in Baedeker Guidebooks (1875-1914)\", Project-Nr.: ÖAW0204.\n Image creation was done in 2004 at the Austrian Academy of Sciences (AAC-Austrian Academy Corpus)."@en;
    n1:hasSubject "Karl Baedeker"@en,
        "historical travel guides"@en;
    n1:hasHosting &lt;https://id.acdh.oeaw.ac.at/arche&gt;;
    n1:hasRightsHolder &lt;https://d-nb.info/gnd/1001454-8&gt;;
    n1:hasLicensor &lt;https://d-nb.info/gnd/1123037736&gt;;
    n1:hasMetadataCreator &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;;
    n1:hasCurator &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;;
    n1:hasCreator &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;; 
    n1:hasDepositor &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;;
    n1:hasContact &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;;
    n1:hasOwner &lt;https://d-nb.info/gnd/1123037736&gt;.

&lt;https://id.acdh.oeaw.ac.at/traveldigital/Corpus/Baedeker-Mittelmeer_1909.xml&gt; a n1:Resource;
    n1:hasTitle "Karl Baedeker: Das Mittelmeer. Handbuch für Reisende: Digital Edition"@en;
    n1:hasCategory &lt;http://purl.org/dc/dcmitype/Dataset&gt;;
    n1:hasDepositor &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;;
    n1:hasMetadataCreator &lt;https://id.acdh.oeaw.ac.at/uczeitschner&gt;;
    n1:hasOwner &lt;https://d-nb.info/gnd/1123037736&gt;;
    n1:hasRightsHolder &lt;https://d-nb.info/gnd/1001454-8&gt;;
    n1:hasLicensor &lt;https://d-nb.info/gnd/1123037736&gt;;
    n1:hasLicense &lt;https://creativecommons.org/licenses/by/4.0/&gt;;
    n1:hasHosting &lt;https://id.acdh.oeaw.ac.at/arche&gt;;
    n1:isPartOf &lt;https://id.acdh.oeaw.ac.at/traveldigital&gt;.
'</span> <span class="o">&gt;</span> collection.ttl
</code></pre></div>        </div>
      </li>
      <li>Ingest the metadata into the repository with:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require acdh-oeaw/arche-ingest
~/vendor/bin/arche-import-metadata collection.ttl http://127.0.0.1/api admin myAdminPassword
</code></pre></div>        </div>
        <ul>
          <li>note down the URLs of created resources reported in the log, e.g.:
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    created http://127.0.0.1/api/11305 <span class="o">(</span>1/2<span class="o">)</span>
    created http://127.0.0.1/api/11306 <span class="o">(</span>2/2<span class="o">)</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>Download and ingest the TEI-XML resource binary:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir sampledata
curl https://arche.acdh.oeaw.ac.at/api/29688 &gt; sampledata/Baedeker-Mittelmeer_1909.xml
~/vendor/bin/arche-import-binary \
    sampledata \
    https://id.acdh.oeaw.ac.at/traveldigital/Corpus \
    http://127.0.0.1/api admin myAdminPassword
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<p>At this point we have a repository with some data in it.<br />
We can check it out in a few ways:</p>

<ul>
  <li>With an API call:
    <ul>
      <li>open URLs of the two ingested resources in your browser
(e.g. http://127.0.0.1/api/11305 and http://127.0.0.1/api/11306 from the examples above)
        <ul>
          <li>the URL of the collection resource will display a metadata view
(note you were redirected to <code class="language-plaintext highlighter-rouge">{originalURL}/metadata</code>)</li>
          <li>the URL of the TEI-XML will download the TEI-XML file
(you can append <code class="language-plaintext highlighter-rouge">/metadata</code> to the URL to display the metadata view)</li>
        </ul>
      </li>
      <li>If you want to display metadata in RDF (instead of HTML) append the <code class="language-plaintext highlighter-rouge">?format={RDF format MIME}</code>,
e.g. <code class="language-plaintext highlighter-rouge">http://127.0.0.1/api/11305/metadata?format=application/rdf%2Bxml</code></li>
      <li>To learn more about fetching metadata trough the API read <a href="/arche-docs/aux/metadata_api_for_programmers.html">here</a></li>
    </ul>
  </li>
  <li>With the <a href="https://github.com/acdh-oeaw/arche-gui">ACDH-CH GUI</a> - open http://localhost/browser/<br />
TODO - check with Norbert why the collection view doesn’t work</li>
  <li>With the <a href="">OAI-PMH</a> service - http://127.0.0.1/oaipmh/?verb=ListRecords&amp;metadataPrefix=oai_dc</li>
</ul>

<h2 id="step-by-step-installation">Step-by-step installation</h2>

<p>Now let’s take a step back and make a step-by-step installation starting from a minimal setup.</p>

<h3 id="installing-arche-core">Installing arche-core</h3>

<p>Let’s say we want to set up a repository:</p>

<ul>
  <li>working under the http://my.domain</li>
  <li><a href="https://github.com/acdh-oeaw/arche-docker#with-postgresql-database-on-other-host">using an external Postgresql database</a></li>
  <li><a href="https://github.com/acdh-oeaw/arche-docker#with-data-directories-in-docker-named-volumes">storing data in a named Docker volume</a></li>
  <li><a href="https://github.com/acdh-oeaw/arche-docker#with-data-directories-mounted-from-host">storing logs in a host directory</a> so we can access them easily</li>
</ul>

<p>Let’s go:</p>

<ul>
  <li>As we will set up the repository locally we need to fake that the <code class="language-plaintext highlighter-rouge">my.domain</code> points to our own machine.
This can be done by adding a line to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code>:
(you need admin rights for that, by the way this file exists also under Windows - google it):
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 my.domain
</code></pre></div>    </div>
  </li>
  <li>Clone a “vanilla” version of the configuration repository.<br />
This will allow us to adjust the configuration in a persistent way.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone <span class="nt">--depth</span> 1 <span class="nt">--branch</span> master https://github.com/acdh-oeaw/arche-docker-config.git
</code></pre></div>    </div>
  </li>
  <li>Adjust the configuration
    <ul>
      <li>Create the instance-specific settings
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>arche-docker-config/yaml/local.yaml.sample arche-docker-config/yaml/local.yaml
</code></pre></div>        </div>
        <p>and edit it so it looks as follows:</p>
        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rest</span><span class="pi">:</span>
  <span class="na">urlBase</span><span class="pi">:</span> <span class="s">http://my.domain</span>
  <span class="na">pathBase</span><span class="pi">:</span> <span class="s">/api/</span>
</code></pre></div>        </div>
      </li>
      <li>Turn off internal Postgresql instance within the arche-core Docker container
(we assumed we will use an external database):
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm arche-docker-config/supervisord.conf.d/postgresql.conf
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Make a local directory for logs:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>log
</code></pre></div>    </div>
  </li>
  <li>Prepare a <a href="https://docs.docker.com/compose/">Docker compose</a> config for our setup in the <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="c1"># container for "external" Postgresql database</span>
  <span class="na">postgresql</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgis/postgis:15-master</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">postgresql:/var/lib/postgresql/data</span>
    <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">backend</span>
    <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">POSTGRES_PASSWORD=${MYREPO_DB_PSWD}"</span>
  <span class="c1"># container for the arche-core</span>
  <span class="na">arche-core</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">acdhch/arche</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">data:/home/www-data/data</span>
    <span class="pi">-</span> <span class="s">./arche-docker-config:/home/www-data/config</span>
    <span class="pi">-</span> <span class="s">./log:/home/www-data/log</span>
    <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">PG_HOST=postgresql</span>
    <span class="pi">-</span> <span class="s">PG_USER=postgres</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">PG_PSWD=${MYREPO_DB_PSWD}"</span>
    <span class="pi">-</span> <span class="s">PG_DBNAME=arche</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">USER_UID=${USER_UID}"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">USER_GID=${USER_GID}"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">ADMIN_PSWD=${ADMIN_PSWD}"</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
    <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">backend</span>
    <span class="pi">-</span> <span class="s">bridge</span>
    <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">postgresql</span>
<span class="na">networks</span><span class="pi">:</span>
  <span class="na">backend</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
  <span class="na">bridge</span><span class="pi">:</span>
<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">postgresql</span><span class="pi">:</span>
  <span class="na">data</span><span class="pi">:</span>
</code></pre></div>    </div>
    <p>and an <code class="language-plaintext highlighter-rouge">.env</code> file containing private environment variables:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MYREPO_DB_PSWD=strongPassword
ADMIN_PSWD=anotherStrongPassword
USER_UID=number reported by running id -u
USER_GID=number reported by running id -g
</code></pre></div>    </div>
  </li>
  <li>Start everything up:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up
</code></pre></div>    </div>
  </li>
  <li>Check if everything works by making a GET request to the http://my.domain/api/describe, e.g.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> http://my.domain/api/describe
</code></pre></div>    </div>
    <p>you should get a YAML file describing the repository instance configuration which might be
relevant from the client perspective.</p>
  </li>
</ul>

<p>Congratulations, at that point we have the repository backbone up and running.</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>If something did not work, you can inspect:</p>

<ul>
  <li>Logs displayed in the terminal in which you run the <code class="language-plaintext highlighter-rouge">docker compose up</code> command.</li>
  <li>ARCHE Suite logs located in the <code class="language-plaintext highlighter-rouge">log</code> directory,
especially the <code class="language-plaintext highlighter-rouge">error.log</code>, <code class="language-plaintext highlighter-rouge">rest.log</code> and ‘initScripts.log`.</li>
</ul>

<h3 id="deciding-on-metadata-schema">Deciding on metadata schema</h3>

<p>ARCHE Suite itself does not enforce any metadata schema.
You can use whichever you want.</p>

<p>Still, some ARCHE components define concepts which have to mapped to RDF properties to make everything work, e.g.</p>

<ul>
  <li>arche-core requires you to assign an RDF property storing repository resource identifiers and a label(s)</li>
  <li>arche-resolver requires you to assign various RDF properties describing dissemination services behavior
(see <a href="https://acdh-oeaw.github.io/arche-docs/aux/dissemination_services.html">here</a>)</li>
  <li>etc.</li>
</ul>

<p>Here and know let’s create a mapping for the arche-core only assuming we want to use Dublin Core 
wherever suitable and artificial predicates for everything else
(especially for the <a href="https://acdh-oeaw.github.io/arche-docs/aux/search_api_for_programmers.html#technical-rdf-properties-provided-by-the-search">technical predicates used by the API</a>.</p>

<p>To do that please modify the top part of the <code class="language-plaintext highlighter-rouge">schema</code> section of the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/schema.yaml</code> so it looks as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">schema</span><span class="pi">:</span>
    <span class="na">id</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/identifier</span> 
    <span class="na">parent</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/isPartOf</span>
    <span class="na">label</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/title</span>
    <span class="na">delete</span><span class="pi">:</span> <span class="s">delete://delete</span>
    <span class="na">searchMatch</span><span class="pi">:</span> <span class="s">search://match</span>
    <span class="na">searchOrder</span><span class="pi">:</span> <span class="s">search://order</span>
    <span class="na">searchOrderValue</span><span class="pi">:</span> <span class="s">search://orderValue</span>
    <span class="na">searchFts</span><span class="pi">:</span> <span class="s">search://fts</span>
    <span class="na">searchCount</span><span class="pi">:</span> <span class="s">search://count</span>
    <span class="na">binarySize</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/extent</span>
    <span class="na">fileName</span><span class="pi">:</span> <span class="s">file://name</span>
    <span class="na">mime</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/format</span>
    <span class="na">hash</span><span class="pi">:</span> <span class="s">file://hash</span>
    <span class="na">modificationDate</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/modified</span>
    <span class="na">modificationUser</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/contributor</span>
    <span class="na">binaryModificationDate</span><span class="pi">:</span> <span class="s">file://modified</span>
    <span class="na">binaryModificationUser</span><span class="pi">:</span> <span class="s">file://modifiedUser</span>
    <span class="na">creationDate</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/created</span>
    <span class="na">creationUser</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/creator</span>
</code></pre></div></div>

<p>and then restart the arche-core by hitting <code class="language-plaintext highlighter-rouge">CTRL+c</code> on the console where you run <code class="language-plaintext highlighter-rouge">docker compose up</code>
and running <code class="language-plaintext highlighter-rouge">docker compose up</code> again.</p>

<h3 id="ingesting-some-data">Ingesting some data</h3>

<p>Let’s ingest one metadata-only resource and a TEI-XML file as its child.</p>

<ul>
  <li>Create a ‘sampleData<code class="language-plaintext highlighter-rouge"> folder and the </code>sampleData/metadata.ttl` in it containing:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@prefix dc: &lt;http://purl.org/dc/terms/&gt;.
&lt;http://id.namespace/collection1&gt; dc:title "Sample collection"@en .
&lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt; dc:title "Sample TEI-XML"@en ;
    dc:isPartOf &lt;http://id.namespace/collection1&gt; .
</code></pre></div>    </div>
  </li>
  <li>Run a dedicated temporary docker container which we will use for the ingestion
(it will have the <code class="language-plaintext highlighter-rouge">sampleData</code> directory availble under <code class="language-plaintext highlighter-rouge">/data</code>):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-ti</span> <span class="nt">--network</span> host <span class="nt">-v</span> ./sampleData:/data acdhch/arche-ingest
</code></pre></div>    </div>
  </li>
  <li>Ingest the metadata file with:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/metadata.ttl http://my.domain/api admin ADMIN_PSWD_as_set_in_.env_file
</code></pre></div>    </div>
    <ul>
      <li>note down the URLs of created resources reported in the log, e.g.:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    created http://my.domain/api/1 <span class="o">(</span>1/2<span class="o">)</span>
    created http://my.domain/api/2 <span class="o">(</span>2/2<span class="o">)</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Download and ingest the TEI-XML resource binary:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://arche.acdh.oeaw.ac.at/api/29688 <span class="o">&gt;</span> /data/Baedeker-Mittelmeer_1909.xml
vendor/bin/arche-import-binary <span class="se">\</span>
  /data <span class="se">\</span>
  http://id.namespace <span class="se">\</span>
  http://my.domain/api admin ADMIN_PSWD_as_set_in_.env_file <span class="se">\</span>
  <span class="nt">--skip</span> not_exist
</code></pre></div>    </div>
    <ul>
      <li>note the URL of the updated resource reported in the log, e.g.:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Processing /data/Baedeker-Mittelmeer_1909.xml <span class="o">(</span>1/2 50%<span class="o">)</span>: update + upload  http://my.domain/api/2
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Leave the ingestion container with
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exit</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Now we have some rudimentary data and we can check if our metadata schema has been picked up.</p>

<p>Fetch the metadata of the TEI-XML binary.<br />
It is http://my.domain/api/2 in my case but check your ingestion logs for yours.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-u</span> <span class="s1">'admin:ADMIN_PSWD_as_set_in_.env_file'</span> <span class="s1">'http://my.domain/api/2/metadata?readMode=resource'</span>
</code></pre></div></div>
<p>which in my case resulted in:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@prefix n0: &lt;http://my.domain/api/&gt;.
@prefix n1: &lt;file://&gt;.
@prefix n2: &lt;http://purl.org/dc/terms/&gt;.
@prefix n3: &lt;http://id.namespace/&gt;.
@prefix n4: &lt;https://vocabs.acdh.oeaw.ac.at/schema#&gt;.

&lt;http://my.domain/api/2&gt; n1:modified "2023-07-06T11:56:53.559750"^^&lt;http://www.w3.org/2001/XMLSchema#dateTime&gt;;
    n2:title "Sample TEI-XML"@en;
    n2:creator "admin";
    n2:isPartOf &lt;http://my.domain/api/1&gt;;
    n2:identifier &lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt;;
    n2:extent "32380001"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt;;
    n2:identifier &lt;http://my.domain/api/2&gt;;
    n2:modified "2023-07-06T11:56:53.659461"^^&lt;http://www.w3.org/2001/XMLSchema#dateTime&gt;;
    n4:aclRead "admin";
    n1:modifiedUser "admin";
    n1:hash "sha1:ad8a457099d70990f6d936182f0e3b2c35a19ad6";
    n2:contributor "admin";
    n4:aclWrite "admin";
    n1:name "Baedeker-Mittelmeer_1909.xml";
    n2:format "application/xml";
    n2:created "2023-07-06T11:56:30.757867"^^&lt;http://www.w3.org/2001/XMLSchema#dateTime&gt;.
</code></pre></div></div>

<p>We can see that:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">dc:title</code>, <code class="language-plaintext highlighter-rouge">dc:identifier</code> and <code class="language-plaintext highlighter-rouge">dc:isPartOf</code>
look exactly like we set them up in the <code class="language-plaintext highlighter-rouge">sampleData/metadata.ttl</code>.</li>
  <li>Quite many other metadata properties have been assigned automatically, e.g.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dc:creator "admin"</code> because we used the <code class="language-plaintext highlighter-rouge">admin</code> account for the ingestion</li>
      <li><code class="language-plaintext highlighter-rouge">dc:extent "32380001"^^&lt;http://www.w3.org/2001/XMLSchema#integer&gt;</code>
and <code class="language-plaintext highlighter-rouge">&lt;file://hash&gt; "sha1:ad8a457099d70990f6d936182f0e3b2c35a19ad6"</code>
because the arche-core computed them while storing the uploaded file</li>
      <li><code class="language-plaintext highlighter-rouge">&lt;file://name&gt; "Baedeker-Mittelmeer_1909.xml"</code> because the upload script
provided this information while uploading the file</li>
      <li>etc.</li>
    </ul>
  </li>
  <li>We can also see some access control-related properties like
<code class="language-plaintext highlighter-rouge">&lt;https://vocabs.acdh.oeaw.ac.at/schema#aclWrite "admin"</code>
but this is discussed in the next chapter.</li>
</ul>

<p>You can also try:</p>

<ul>
  <li>Fetching metadata of a given resource and all repository resources it points to in a single REST API call:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-u</span> <span class="s1">'admin:ADMIN_PSWD_as_set_in_.env_file'</span> <span class="s1">'http://my.domain/api/2/metadata?readMode=neighbors'</span>
</code></pre></div>    </div>
  </li>
  <li>Fetching the resource binary:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -u 'admin:ADMIN_PSWD_as_set_in_.env_file' 'http://my.domain/api/2'
</code></pre></div>    </div>
  </li>
  <li>Checking that without providing the username and the password, you are denied access
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -i http://my.domain/api/2
</code></pre></div>    </div>
  </li>
</ul>

<p>The <a href="https://github.com/acdh-oeaw/arche-ingest">arche-ingest</a> repository provides
scripts automating metadata and binary data repository upload.</p>

<h3 id="acess-control">Acess control</h3>

<p>Access control is based on <em>roles</em> which are generalization of the <em>user</em> and <em>group</em> concepts.</p>

<ul>
  <li>During the arche-core initialization an <code class="language-plaintext highlighter-rouge">admin</code> <em>role</em> is created.</li>
  <li>There is also a <code class="language-plaintext highlighter-rouge">public</code> role which is used to indicate unauthenticated users.</li>
</ul>

<p>You can create and modify users using the <code class="language-plaintext highlighter-rouge">{repo base URL}/user</code> REST API endpoint
(see <a href="https://app.swaggerhub.com/apis/zozlak/arche">swagger API documentation</a> for details), e.g.</p>

<ul>
  <li>List existing roles with (the output is in JSON):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-u</span> <span class="s1">'admin:ADMIN_PSWD_as_set_in_.env_file'</span> <span class="s1">'http://my.domain/api/user'</span>
</code></pre></div>    </div>
  </li>
  <li>Add a new role <code class="language-plaintext highlighter-rouge">bob</code> belonging to the <code class="language-plaintext highlighter-rouge">creators</code> role:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="nt">-u</span> <span class="s1">'admin:anotherStrongPassword'</span> <span class="s1">'http://my.domain/api/user/bob'</span> <span class="se">\</span>
  <span class="nt">-X</span> PUT <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">--data-binary</span> <span class="s1">'{"groups": ["creators"], "password": "randomPassword"}'</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>The access control settings are stored in the <code class="language-plaintext highlighter-rouge">accessControl</code> section of the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/repo.yaml</code> file.</p>

<p>In our case it should look more or less as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">accessControl</span><span class="pi">:</span>
    <span class="na">publicRole</span><span class="pi">:</span> <span class="s">public</span>
    <span class="na">adminRoles</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">admin</span>
    <span class="na">create</span><span class="pi">:</span>
        <span class="c1"># who can create new resources</span>
        <span class="na">allowedRoles</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">creators</span>
        <span class="c1"># rights assigned to the creator uppon resource creation</span>
        <span class="na">creatorRights</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">read</span>
            <span class="pi">-</span> <span class="s">write</span>
        <span class="c1"># rights assigned to other roles upon resource creation</span>
        <span class="na">assignRoles</span><span class="pi">:</span>
            <span class="na">read</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">defaultAction</span><span class="pi">:</span>
        <span class="na">read</span><span class="pi">:</span> <span class="s">deny</span>
        <span class="na">write</span><span class="pi">:</span> <span class="s">deny</span>
    <span class="na">enforceOnMetadata</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">schema</span><span class="pi">:</span>
        <span class="na">read</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#aclRead</span>
        <span class="na">write</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#aclWrite</span>
    <span class="na">db</span><span class="pi">:</span>
        <span class="na">connStr</span><span class="pi">:</span> <span class="s1">'</span><span class="s">pgsql:</span><span class="nv"> </span><span class="s">user={PG_USER_PREFIX}repo</span><span class="nv"> </span><span class="s">dbname={PG_DBNAME}</span><span class="nv"> </span><span class="s">host={PG_HOST}</span><span class="nv"> </span><span class="s">port={PG_PORT}'</span>
        <span class="na">table</span><span class="pi">:</span> <span class="s">users</span>
        <span class="na">userCol</span><span class="pi">:</span> <span class="s">user_id</span>
        <span class="na">dataCol</span><span class="pi">:</span> <span class="s">data</span>
    <span class="na">authMethods</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">class</span><span class="pi">:</span> <span class="s">\zozlak\auth\authMethod\TrustedHeader</span>
          <span class="na">parameters</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">HTTP_EPPN</span>
        <span class="pi">-</span> <span class="na">class</span><span class="pi">:</span> <span class="s">\zozlak\auth\authMethod\HttpBasic</span>
          <span class="na">parameters</span><span class="pi">:</span>
             <span class="pi">-</span> <span class="s">repo</span>
        <span class="pi">-</span> <span class="na">class</span><span class="pi">:</span> <span class="s">\zozlak\auth\authMethod\Guest</span>
          <span class="na">parameters</span><span class="pi">:</span>
             <span class="pi">-</span> <span class="s">public</span>
</code></pre></div></div>

<p>Let’s analyze it step-by-step:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">publicRole: public</code> - defines the name of the role used to indicate unauthorized user</li>
  <li>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">adminRoles</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">admin</span>
</code></pre></div>    </div>
    <p>defines the list of admin roles.
Admin rights are needed to create new roles.
Also, having the admin rights allows to freely create, read, modify and delete repository resources.</p>
  </li>
  <li>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">create</span><span class="pi">:</span>
      <span class="na">allowedRoles</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">creators</span>
      <span class="na">creatorRights</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">read</span> 
          <span class="pi">-</span> <span class="s">write</span>
      <span class="na">assignRoles</span><span class="pi">:</span>
          <span class="na">read</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div>    </div>
    <p>defines who can create new repository resources 
and what are the default access rights being set on newly created resources.
Here:</p>
    <ul>
      <li>only <em>roles</em> belonging to the <em>creators</em> role (and, obviously, admins) can create new resources</li>
      <li>the creator is automatically assigned <em>read</em> and <em>write</em> rights on a created resource
(which is a sane default but e.g. dropping <code class="language-plaintext highlighter-rouge">write</code> from this list would enforce
creation of immutable repository resources, at least until you are and admin)</li>
      <li>no other roles are assigned rights on a newly create resource
        <ul>
          <li>if you would like a newly created resource to be read-only by everyone you could use
            <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">assignRoles</span><span class="pi">:</span>
      <span class="na">read</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">public</span><span class="pi">]</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">defaultAction</span><span class="pi">:</span>
      <span class="na">read</span><span class="pi">:</span> <span class="s">deny</span>
      <span class="na">write</span><span class="pi">:</span> <span class="s">deny</span>
</code></pre></div>    </div>
    <p>determines what to use if no access control rule has been matched.
In this case the access is denied.
You can e.g. consider setting <code class="language-plaintext highlighter-rouge">write: allow</code>.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">enforceOnMetadata: true</code> enforces the <strong>read</strong> access rights
to be applied also to metadata (the write access rights are always applied
both to the metadata and resource binary content).</li>
  <li>The <code class="language-plaintext highlighter-rouge">schema</code> section defines RDF properties used to store 
access control information in the metadata.
You can choose them however you want, just do the adjustment before 
you start ingesting resources into the repository.</li>
  <li>The <code class="language-plaintext highlighter-rouge">db</code> section contains internal config we will not dig into.</li>
  <li>The <code class="language-plaintext highlighter-rouge">auth</code> section contains configuration of the <a href="https://github.com/zozlak/auth">zozlak/auth</a>
authentication framework. In this case:
    <ul>
      <li>First we check for the presence of the <code class="language-plaintext highlighter-rouge">EPPN</code> HTTP header
and if it exists, we take the <em>role</em> name from the header value.
This is quite a common integration scenario for the single sign-on
authorization methods like the Shibboleth Apache module.</li>
      <li>Then a standard username &amp; password based authentication is used.</li>
      <li>If both failed, a fixed role <code class="language-plaintext highlighter-rouge">public</code> is assumed.</li>
    </ul>
  </li>
</ul>

<p>Now let’s try to use the <code class="language-plaintext highlighter-rouge">bob</code> role we created in the examples at the beginning of the chapter
to allow public read rights on the TEI-XML resource (http://my.domain/api/2 in my case).</p>

<p>First, we need to allow <code class="language-plaintext highlighter-rouge">bob</code> to modify the resouces which is currently possible only for the <code class="language-plaintext highlighter-rouge">admin</code> role
(and all roles with admin priviledges).
This can be done</p>

<ul>
  <li>By adding <code class="language-plaintext highlighter-rouge">bob</code> to the <code class="language-plaintext highlighter-rouge">accessControl.adminRoles</code> list in the arche-docker-config/yaml/repo.yaml
and restarting the repository’s Docker container. But we will not use it as we do not want <code class="language-plaintext highlighter-rouge">bob</code>
to become an admin.</li>
  <li>Or by granting <code class="language-plaintext highlighter-rouge">bob</code> writes to modify the resource.
Presicely by adding the <code class="language-plaintext highlighter-rouge">accessControl.schema.write "bob"</code> triple
(in our case <code class="language-plaintext highlighter-rouge">&lt;https://vocabs.acdh.oeaw.ac.at/schema#aclWrite&gt; "bob"</code>) to resource’s metadata.
This is the solution we prefer.</li>
</ul>

<p>For that let’s create a <code class="language-plaintext highlighter-rouge">sampleData/acl1.ttl</code> file:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt; &lt;https://vocabs.acdh.oeaw.ac.at/schema#aclWrite&gt; "bob", "admin" .
&lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt; &lt;https://vocabs.acdh.oeaw.ac.at/schema#aclRead&gt; "bob", "admin" .
</code></pre></div></div>

<p>After ingesting it <code class="language-plaintext highlighter-rouge">bob</code> should be able to grant public read writes by importing a <code class="language-plaintext highlighter-rouge">sampleData/acl2.ttl</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt; &lt;https://vocabs.acdh.oeaw.ac.at/schema#aclRead&gt; "public" .
</code></pre></div></div>

<p>Let’s ingest both metadata files the same way we did before:</p>

<ul>
  <li>Run a dedicated temporary docker container which we will use for the ingestion
(it will have the <code class="language-plaintext highlighter-rouge">sampleData</code> directory availble under <code class="language-plaintext highlighter-rouge">/data</code>):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-ti</span> <span class="nt">--network</span> host <span class="nt">-v</span> ./sampleData:/data acdhch/arche-ingest
</code></pre></div>    </div>
  </li>
  <li>Try to ingest the <code class="language-plaintext highlighter-rouge">acl1.ttl</code> as the <code class="language-plaintext highlighter-rouge">bob</code> user:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/acl1.ttl http://my.domain/api bob randomPassword
</code></pre></div>    </div>
    <p>and note it failed to perform the update</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>...<span class="o">)</span>
Ingested resources count: 0 errors count: 0
</code></pre></div>    </div>
  </li>
  <li>No try again as <code class="language-plaintext highlighter-rouge">admin</code>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/acl1.ttl http://my.domain/api admin ADMIN_PSWD_as_set_in_.env_file
</code></pre></div>    </div>
    <p>which should succeed</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>...<span class="o">)</span>
Importing http://id.namespace/Baedeker-Mittelmeer_1909.xml <span class="o">(</span>1/1<span class="o">)</span>
    updating http://my.domain/api/2 <span class="o">(</span>1/1<span class="o">)</span>
Ingested resources count: 1 errors count: 0
</code></pre></div>    </div>
  </li>
  <li>At this point bob should have rights to perform the update
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/acl2.ttl http://my.domain/api bob randomPassword
</code></pre></div>    </div>
  </li>
  <li>Leave the ingestion container
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exit</span>
</code></pre></div>    </div>
  </li>
  <li>And we should be able to read the resource without any authentication:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="s1">'http://my.domain/api/2/metadata?readMode=resource'</span>
curl <span class="s1">'http://my.domain/api/2'</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="setting-up-a-basic-oai-pmh">Setting up a basic OAI-PMH</h3>

<p>Now let’s try to add an <a href="https://www.openarchives.org/pmh/">OAI-PMH</a>
service to our repository to make it harvestable by external aggregators.</p>

<p>We can deploy it either in the same docker container as the arche-core or in a separate one.
In this example we will use the first approach.</p>

<ul>
  <li>Add <code class="language-plaintext highlighter-rouge">acdh-oeaw/arche-oaipmh</code> to the packages list in <code class="language-plaintext highlighter-rouge">arche-docker-config/composer.json</code>:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"acdh-oeaw/arche-core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"zozlak/yaml-merge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"acdh-oeaw/arche-oaipmh"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
    <p>This will make the <a href="https://github.com/acdh-oeaw/arche-oaipmh">arche-oaipmh</a> being installed
on the Docker container startup.</p>
  </li>
  <li>Create and <strong>make executable</strong> (<code class="language-plaintext highlighter-rouge">chmod +x arche-docker-config/run.d/oaipmh.sh</code>)
the <code class="language-plaintext highlighter-rouge">arche-docker-config/run.d/oaipmh.sh</code> file
initializing the OAI-PMH service under the <code class="language-plaintext highlighter-rouge">{repoBaseUrl}/oaipmh</code> path:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> /home/www-data/docroot/oaipmh <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'mkdir /home/www-data/docroot/oaipmh'</span>
    su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'ln -s /home/www-data/vendor /home/www-data/docroot/oaipmh/vendor'</span>
<span class="k">fi
</span>su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'cp /home/www-data/vendor/acdh-oeaw/arche-oaipmh/.htaccess /home/www-data/docroot/oaipmh/.htaccess'</span>
su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'cp /home/www-data/vendor/acdh-oeaw/arche-oaipmh/index.php /home/www-data/docroot/oaipmh/index.php'</span>

<span class="c"># compile the final resolver config file from arche-docker-config/yaml/schema.yaml,</span>
<span class="c"># arche-docker-config/yaml/resolver.yaml and arche-docker-config/yaml/local.yaml</span>
<span class="nv">CMD</span><span class="o">=</span>/home/www-data/vendor/zozlak/yaml-merge/bin/yaml-edit.php
<span class="nv">CFGD</span><span class="o">=</span>/home/www-data/config/yaml
<span class="nb">rm</span> <span class="nt">-f</span> /home/www-data/docroot/oaipmh/config.yaml <span class="nv">$CFGD</span>/config-oaipmh.yaml
su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2"> --src </span><span class="nv">$CFGD</span><span class="s2">/oaipmh.yaml --src </span><span class="nv">$CFGD</span><span class="s2">/local.yaml </span><span class="nv">$CFGD</span><span class="s2">/config-oaipmh.yaml"</span>
su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s2">"ln -s </span><span class="nv">$CFGD</span><span class="s2">/config-oaipmh.yaml /home/www-data/docroot/oaipmh/config.yaml"</span>
</code></pre></div>    </div>
  </li>
  <li>Create a minimal OAI-PMH service configuration file <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/oaipmh.yaml</code>:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">oai</span><span class="pi">:</span>
  <span class="na">info</span><span class="pi">:</span>
      <span class="na">repositoryName</span><span class="pi">:</span> <span class="s">my repository</span>
      <span class="na">baseURL</span><span class="pi">:</span> <span class="s">http://my.domain/oaipmh/</span>
      <span class="na">earliestDatestamp</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1900-01-01T00:00:00Z"</span>
      <span class="na">adminEmail</span><span class="pi">:</span> <span class="s">admin@my.domain</span>
      <span class="na">granularity</span><span class="pi">:</span> <span class="s">YYYY-MM-DDThh:mm:ssZ</span>
  <span class="c1"># the guest user is created during the arche-core initialization and we can reuse it</span>
  <span class="na">dbConnStr</span><span class="pi">:</span> <span class="s2">"</span><span class="s">pgsql:</span><span class="nv"> </span><span class="s">user=guest</span><span class="nv"> </span><span class="s">dbname=postgres</span><span class="nv"> </span><span class="s">host=postgresql"</span>
  <span class="na">cacheDir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">logging</span><span class="pi">:</span>
      <span class="na">file</span><span class="pi">:</span> <span class="s">/home/www-data/log/oaipmh.log</span>
      <span class="na">level</span><span class="pi">:</span> <span class="s">info</span>
  <span class="na">deleted</span><span class="pi">:</span>
      <span class="na">deletedClass</span><span class="pi">:</span> <span class="s">\acdhOeaw\arche\oaipmh\deleted\Tombstone</span>
      <span class="na">deletedRecord</span><span class="pi">:</span> <span class="s">transient</span>
  <span class="na">search</span><span class="pi">:</span>
      <span class="na">searchClass</span><span class="pi">:</span> <span class="s">\acdhOeaw\arche\oaipmh\search\BaseSearch</span>
      <span class="na">dateProp</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/modified</span>
      <span class="na">idNmsp</span><span class="pi">:</span> <span class="s">http://my.domain</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">http://purl.org/dc/terms/identifier</span>
      <span class="na">searchMatch</span><span class="pi">:</span> <span class="s">search://match</span>
      <span class="na">searchCount</span><span class="pi">:</span> <span class="s">search://count</span>
      <span class="na">repoBaseUrl</span><span class="pi">:</span> <span class="s">http://my.domain/api/</span>
      <span class="na">resumptionTimeout</span><span class="pi">:</span> <span class="m">120</span>
      <span class="na">resumptionDir</span><span class="pi">:</span> <span class="s2">"</span><span class="s">tmp"</span>
      <span class="na">resumptionKeepAlive</span><span class="pi">:</span> <span class="m">600</span>
  <span class="na">sets</span><span class="pi">:</span>
      <span class="na">setClass</span><span class="pi">:</span> <span class="s">\acdhOeaw\arche\oaipmh\set\NoSets</span>
  <span class="na">formats</span><span class="pi">:</span>
      <span class="na">oai_dc</span><span class="pi">:</span>
          <span class="na">metadataPrefix</span><span class="pi">:</span> <span class="s">oai_dc</span>
          <span class="na">schema</span><span class="pi">:</span> <span class="s">http://www.openarchives.org/OAI/2.0/oai_dc.xsd</span>
          <span class="na">metadataNamespace</span><span class="pi">:</span> <span class="s">http://www.openarchives.org/OAI/2.0/oai_dc/</span>
          <span class="na">class</span><span class="pi">:</span> <span class="s">\acdhOeaw\arche\oaipmh\metadata\DcMetadata</span>
</code></pre></div>    </div>
    <p>For more details please look at the <a href="https://github.com/acdh-oeaw/arche-oaipmh/blob/master/config-sample.yaml">sample config</a>
provided in the arche-oaimph git repository and at the 
<a href="https://acdh-oeaw.github.io/arche-docs/devdocs/namespaces/acdhoeaw-arche-oaipmh-metadata.html">metadata format classes documentation</a>.</p>
  </li>
  <li>Restart the arche-core by hitting <code class="language-plaintext highlighter-rouge">CTRL+c</code> on the console where you run <code class="language-plaintext highlighter-rouge">docker compose up</code>
and running <code class="language-plaintext highlighter-rouge">docker compose up</code> again.</li>
</ul>

<p>We should have the OAI-PMH service with a very basic configuration running now.
You can try:</p>

<ul>
  <li>http://my.domain/oaipmh/?verb=Identify</li>
  <li>http://my.domain/oaipmh/?verb=ListMetadataFormats</li>
  <li>http://my.domain/oaipmh/?verb=ListIdentifiers</li>
  <li>http://my.domain/oaipmh/?verb=ListRecords&amp;metadataPrefix=oai_dc</li>
</ul>

<p>As we internally store metadata in the Dublin Core schema, it was possible to use the very simple
metadata format class <code class="language-plaintext highlighter-rouge">\acdhOeaw\arche\oaipmh\metadata\DcMetadata</code> which does not require any
additional config.
In real-world scenarios you will almost for sure need to prepare templates using the
<code class="language-plaintext highlighter-rouge">\acdhOeaw\arche\oaipmh\metadata\LiveCmdiMetadata</code> class which will map your internal
metadata schema into the schema you want to provide to an external aggregator.
Please read <a href="https://acdh-oeaw.github.io/arche-docs/devdocs/classes/acdhOeaw-arche-oaipmh-metadata-LiveCmdiMetadata.html">this documentation</a>
and <a href="https://github.com/acdh-oeaw/arche-docker-config/tree/arche/oaipmhTemplates">template examples used at the ACDH-CH</a>.</p>

<h3 id="plugging-in-checks-on-the-data-ingestion">Plugging in checks on the data ingestion</h3>

<p>Now an advanced topic - plugging your own logic into the arche-core.</p>

<p>This is possible in two ways:</p>

<ul>
  <li>With handlers written in PHP
    <ul>
      <li>For <code class="language-plaintext highlighter-rouge">txBegin</code>, <code class="language-plaintext highlighter-rouge">txCommit</code> and <code class="language-plaintext highlighter-rouge">txRollback</code> events your handler signature should be:
        <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">myHandler</span><span class="p">(</span>
    <span class="kt">string</span> <span class="nv">$event</span><span class="p">,</span> 
    <span class="kt">int</span> <span class="nv">$transactionId</span><span class="p">,</span> 
    <span class="kt">array</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span> <span class="nv">$idsOfResourcesModifiedByTheTransaction</span><span class="p">)</span>
<span class="p">)</span><span class="o">:</span> <span class="n">void</span>
</code></pre></div>        </div>
      </li>
      <li>For all other events
(<code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">getMetadata</code>, <code class="language-plaintext highlighter-rouge">create</code>, <code class="language-plaintext highlighter-rouge">updateBinary</code>, <code class="language-plaintext highlighter-rouge">updateMetadata</code>, <code class="language-plaintext highlighter-rouge">delete</code>, <code class="language-plaintext highlighter-rouge">deleteTombstone</code>)
your handler signature should be:
        <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">myHandler</span><span class="p">(</span>
    <span class="kt">string</span> <span class="nv">$event</span><span class="p">,</span>
    <span class="kt">EasyRdf</span><span class="err">\</span><span class="nc">Resource</span> <span class="nv">$resourceMetadata</span><span class="p">,</span>
    <span class="o">?</span><span class="n">string</span> <span class="nv">$pathToBinaryPayload</span>
<span class="p">)</span><span class="o">:</span> <span class="nc">EasyRdf\Resource</span>
</code></pre></div>        </div>
        <p>and it should return the final metadata of the resource (as an <code class="language-plaintext highlighter-rouge">EasyRdf\Resource</code> object).</p>
      </li>
      <li>Handlers can break hadnling of a request by throwing an exception.
In such a case the exception code is used as HTTP response code
(e.g. 400 to indicate error in data provided by a user)
and exception message is provided in the response body.</li>
      <li>To register such a handler:
        <ul>
          <li>Make sure its code is being loaded or autoloadable.</li>
          <li>Register it in the <code class="language-plaintext highlighter-rouge">rest.handlers</code> section of the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/repo.yaml</code> file, e.g.
            <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rest</span><span class="pi">:</span>
  <span class="na">handlers</span><span class="pi">:</span>
    <span class="na">create</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">function</span>
      <span class="na">function</span><span class="pi">:</span> <span class="s">myClassName::myHandler</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>You can search for an inspiration by looking at
<a href="https://github.com/acdh-oeaw/arche-doorkeeper/blob/master/src/acdhOeaw/arche/doorkeeper/Doorkeeper.php">our handlers code</a>
and the way we <a href="https://github.com/acdh-oeaw/arche-docker-config/blob/arche/yaml/doorkeeper.yaml#L24">registered them in the configuration</a>.</li>
    </ul>
  </li>
  <li>With handlers written in <a href="https://www.rabbitmq.com/devtools.html">any language with AMQP support</a>
and communicating with the arche-core over an AMQP broker (e.g. the <a href="https://www.rabbitmq.com/">RabbitMQ</a>).
    <ul>
      <li>The message passed to the handler is a JSON object with following properties:
        <ul>
          <li>For <code class="language-plaintext highlighter-rouge">txBegin</code>, <code class="language-plaintext highlighter-rouge">txCommit</code> and <code class="language-plaintext highlighter-rouge">txRollback</code> events:
            <ul>
              <li><code class="language-plaintext highlighter-rouge">method</code> - event name, e.g. <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">updateMetadata</code>, etc.</li>
              <li><code class="language-plaintext highlighter-rouge">transactionId</code> - identifier of the transaction</li>
              <li><code class="language-plaintext highlighter-rouge">resourceIds</code> - array containing interal ids of repository resouced 
modified by this transaction (e.g. <code class="language-plaintext highlighter-rouge">[3, 8, 125]</code>)</li>
            </ul>
          </li>
          <li>For all other events
(<code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">getMetadata</code>, <code class="language-plaintext highlighter-rouge">create</code>, <code class="language-plaintext highlighter-rouge">updateBinary</code>, <code class="language-plaintext highlighter-rouge">updateMetadata</code>, <code class="language-plaintext highlighter-rouge">delete</code>, <code class="language-plaintext highlighter-rouge">deleteTombstone</code>):
            <ul>
              <li><code class="language-plaintext highlighter-rouge">method</code> - event name, e.g. <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">updateMetadata</code>, etc.</li>
              <li><code class="language-plaintext highlighter-rouge">path</code> - path to the resource binary content</li>
              <li><code class="language-plaintext highlighter-rouge">URI</code> - full resource URI, e.g. http://my.domain/api/2</li>
              <li><code class="language-plaintext highlighter-rouge">id</code> - numeric internal id of the resource, e.g. <code class="language-plaintext highlighter-rouge">2</code></li>
              <li><code class="language-plaintext highlighter-rouge">metadata</code> - RDF metadata of the resources in the application/n-triples format</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>the handler is expected to respond with a message being a JSON object containing
the <code class="language-plaintext highlighter-rouge">status</code> field.
        <ul>
          <li>Status of 0 means handler executed successfully.
In case of <code class="language-plaintext highlighter-rouge">txBegin</code>, <code class="language-plaintext highlighter-rouge">txCommit</code> and <code class="language-plaintext highlighter-rouge">txRollback</code> events, that is it.
For other events the respons from the handler should also provide target resource’s
metadata serialized in <code class="language-plaintext highlighter-rouge">application/n-triples</code> in the <code class="language-plaintext highlighter-rouge">metadata</code> property.</li>
          <li>Non-0 status indicates an error.
In such a case the request processing is being stopped and an error response is sent to the client
with an HTTP status code equal to the <code class="language-plaintext highlighter-rouge">status</code> property value and the response body containing
the optional <code class="language-plaintext highlighter-rouge">message</code> property value (if it is missing, a default error message is used).</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>By the way it is possible to mix both methods.</p>

<p>As the first approach (PHP handlers with no AMQP) is well illustrated in our own ARCHE Suite deployment
code (you may look <a href="https://github.com/acdh-oeaw/arche-doorkeeper/blob/master/src/acdhOeaw/arche/doorkeeper/Doorkeeper.php">here</a>
and <a href="https://github.com/acdh-oeaw/arche-docker-config/blob/arche/yaml/doorkeeper.yaml#L24">here</a>),
in this tutorial we will take the second approach and implement a simple metadata consistency check handler in Python
over the AMQP.</p>

<ul>
  <li>Let’s start with adding a <a href="https://www.rabbitmq.com/">RabbitMQ</a> broker service to our
Docker containers stack.
It will pass messages between the arche-core and our handlers service.
    <ul>
      <li>Extend the <code class="language-plaintext highlighter-rouge">services</code> section of the <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> with:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>services:
  rabbitmq:
    image: rabbitmq
    networks:
    - backend
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>We also need an execution enviromnent for our Python handlers service.
This makes another Docker container.
    <ul>
      <li>Extend the <code class="language-plaintext highlighter-rouge">services</code> section of the <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> with:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>services:
  handlers:
    image: python:3.11
    networks:
    - backend
    volumes:
    - ./handlers:/opt
    entrypoint: /opt/start.sh
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Now let’s create the starup script for our handlers Docker container.
It will install required Python libraries and then start our handlers
service.
    <ul>
      <li>Create the <code class="language-plaintext highlighter-rouge">handlers</code> directory</li>
      <li>Create and <strong>make executable</strong> <code class="language-plaintext highlighter-rouge">handlers/start.sh</code>:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># install required python modules</span>
pip <span class="nb">install </span>pika
pip <span class="nb">install </span>rdflib
<span class="c"># give rabbitmq some time to start</span>
<span class="nb">sleep </span>10
<span class="c"># start our handlers service</span>
python3 /opt/handlers.py
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Create a simple handler code.<br />
It will check if the <code class="language-plaintext highlighter-rouge">dc:license</code> triple is defined in the resource metadata.<br />
On top of it we need a little boilerplate code to couple it with the AMQP broker.<br />
Edit <code class="language-plaintext highlighter-rouge">handlers/handlers.py</code> so it contains:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">URIRef</span>

<span class="c1"># this is our handler
</span><span class="k">def</span> <span class="nf">checkMeta</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">deliver</span><span class="p">,</span> <span class="n">msgProperties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
  <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
  <span class="n">g</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">message</span><span class="p">[</span><span class="s">'metadata'</span><span class="p">])</span>
  <span class="c1"># if http://purl.org/dc/terms/license is not provided
</span>  <span class="c1"># return an empty graph and set an error message
</span>  <span class="k">if</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="s">'http://purl.org/dc/terms/license'</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
    <span class="n">retMsg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'status'</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="s">'message'</span><span class="p">:</span> <span class="s">'dc:license triple is missing'</span>
    <span class="p">}</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">retMsg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">'status'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s">'metadata'</span><span class="p">:</span> <span class="n">g</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s">'nt'</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
    <span class="n">exchange</span><span class="o">=</span><span class="n">deliver</span><span class="p">.</span><span class="n">exchange</span><span class="p">,</span> 
    <span class="n">routing_key</span><span class="o">=</span><span class="n">msgProperties</span><span class="p">.</span><span class="n">reply_to</span><span class="p">,</span>
    <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">retMsg</span><span class="p">),</span>
    <span class="n">properties</span><span class="o">=</span><span class="n">msgProperties</span>
  <span class="p">)</span>

<span class="c1"># boilerplate code coupling our handler with the AMQP broker
</span><span class="n">connCfg</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'rabbitmq'</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">connCfg</span><span class="p">)</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>
<span class="n">channel</span><span class="p">.</span><span class="n">basic_qos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="c1"># create the 'onModify' queue
</span><span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">'onModify'</span><span class="p">)</span>
<span class="c1"># set up a handler function
</span><span class="n">channel</span><span class="p">.</span><span class="n">basic_consume</span><span class="p">(</span>
  <span class="n">queue</span><span class="o">=</span><span class="s">'onModify'</span><span class="p">,</span> 
  <span class="n">on_message_callback</span><span class="o">=</span><span class="n">checkMeta</span><span class="p">,</span>
  <span class="n">auto_ack</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>
<span class="n">channel</span><span class="p">.</span><span class="n">start_consuming</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>Tell the arche-core to use AMQP handlers.
Edit the <code class="language-plaintext highlighter-rouge">rest.handlers</code> section of the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/repo.yaml</code>:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">handlers</span><span class="pi">:</span>
  <span class="na">rabbitMq</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">rabbitmq</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">5672</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">guest</span> <span class="c1"># default settings of the rabbitmq docker image</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">guest</span> <span class="c1"># default settings of the rabbitmq docker image</span>
    <span class="na">timeout</span><span class="pi">:</span> <span class="m">5</span> <span class="c1"># handler execution timeout in seconds</span>
    <span class="na">exceptionOnTimeout</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">methods</span><span class="pi">:</span>
    <span class="na">create</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">rpc</span>
      <span class="na">queue</span><span class="pi">:</span> <span class="s">onModify</span> <span class="c1"># must match the queue name in Python code</span>
    <span class="na">updateBinary</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">updateMetadata</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">rpc</span>
      <span class="na">queue</span><span class="pi">:</span> <span class="s">onModify</span> <span class="c1"># must match the queue name in Python code</span>
    <span class="na">txCommit</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div>    </div>
  </li>
  <li>Restart the arche-core by hitting <code class="language-plaintext highlighter-rouge">CTRL+c</code> on the console where you run <code class="language-plaintext highlighter-rouge">docker compose up</code>
and running <code class="language-plaintext highlighter-rouge">docker compose up</code> again.<br />
Wait until you see `</li>
  <li>Test if it works
    <ul>
      <li>Run a dedicated temporary docker container which we will use for the ingestion (it will have the sampleData directory availble under /data):
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-ti</span> <span class="nt">--network</span> host <span class="nt">-v</span> ./sampleData:/data acdhch/arche-ingest
</code></pre></div>        </div>
      </li>
      <li>Try to reingest the <code class="language-plaintext highlighter-rouge">metadata.ttl</code> file we used in the previous chapter:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/metadata.ttl http://my.domain/api admin ADMIN_PSWD_as_set_in_.env_file
</code></pre></div>        </div>
        <p>You should get something like</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(...)
Importing http://id.namespace/Baedeker-Mittelmeer_1909.xml (2/2)
updating http://my.domain/api/1 (1/2)
updating http://my.domain/api/2 (2/2)
ERROR while processing http://id.namespace/collection1: 400 dc:license triple is missing(GuzzleHttp\Exception\ClientException)
ERROR while processing http://id.namespace/Baedeker-Mittelmeer_1909.xml: 400 dc:license triple is missing(GuzzleHttp\Exception\ClientException)
(...)
</code></pre></div>        </div>
        <p>which is exactly what we wanted - our metadata check procedure revoked
the metadata update requests with the HTTP code 400 (Bad Request)
 because the <code class="language-plaintext highlighter-rouge">dc:licence</code> RDF triple was missing.</p>
        <ul>
          <li>If you got another error code, try looking at the logs
in the <code class="language-plaintext highlighter-rouge">docs/rest.log</code></li>
        </ul>
      </li>
      <li>Edit the <code class="language-plaintext highlighter-rouge">sampleData/metadata.ttl</code> adding <code class="language-plaintext highlighter-rouge">dc:license</code> triples
for both resources to it, e.g.:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@prefix dc: &lt;http://purl.org/dc/terms/&gt;.
    &lt;http://id.namespace/collection1&gt; dc:title "Sample collection"@en ;
    dc:license "CC BY-NC" .
&lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt; dc:title "Sample TEI-XML"@en ;
    dc:isPartOf &lt;http://id.namespace/collection1&gt; ;
    dc:license "CC BY-NC".
</code></pre></div>        </div>
      </li>
      <li>Try to ingest again:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/metadata.ttl http://my.domain/api admin ADMIN_PSWD_as_set_in_.env_file
</code></pre></div>        </div>
        <p>This time the ingestion should succeed.</p>
        <ul>
          <li>If you git an error, try looking at the logs in the <code class="language-plaintext highlighter-rouge">docs/rest.log</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Congratulations, you have just created and tested a very basic
data consistency check.</li>
</ul>

<p>Remarks about a production environment usage:</p>

<ul>
  <li>If you want to use multiple AMQP handlers for different events
(<code class="language-plaintext highlighter-rouge">txBegin/txCommit/txRollback/get/getMetadata/create/updateBinary/updateMetadata/delete/deleteTombstone</code>),
you should assign each of them a unique queue name.</li>
  <li>You should rather make a dedicated Docker image containing a complete 
execution environment for your handlers service rather than installing 
libraries as a part of the <code class="language-plaintext highlighter-rouge">handlers/start.sh</code>.</li>
  <li>You should either set up RabbitMQ authorization or make sure you
run in in an izolated and trusted network.</li>
  <li>Instead of just waiting 10 seconds for the RabbitMQ to start you should
rather implement a loop checking and waiting until the service is available
either in the <code class="language-plaintext highlighter-rouge">handlers/start.sh</code> or in the <code class="language-plaintext highlighter-rouge">handlers/handlers.py</code>.</li>
  <li>If you expect higher repository loads, you may need to write your
handlers in a way multiple checks can run at once. Please consult
the AMQP broker of your choice (e.g. the RabbigMQ) documentation
to check how to do that.
    <ul>
      <li>This problem does not exist in case of handlers written in PHP
and not using the AMQP.</li>
    </ul>
  </li>
</ul>

<p>Other remarks:</p>

<ul>
  <li>The <a href="https://github.com/acdh-oeaw/arche-openaire/">arche-openaire</a> repository
provides a set of handlers for integrating the ARCHE Suite repository with
the <a href="https://openaire.github.io/usage-statistics-guidelines/service-specification/service-spec/">OpenAIRE usage statistics tracking</a></li>
</ul>

<h3 id="adding-pids-resolver-and-content-format-negotation">Adding PIDs resolver and content format negotation</h3>

<p>You probably want to assign <a href="https://en.wikipedia.org/wiki/Persistent_identifier">PIDs</a>
to resources in your repository.</p>

<p>You can depend on an external PIDs service for that (e.g. a https://www.handle.net/) but
this requires a constant maintenance (e.g. if you migrate your repository base URL, you
need to update all the handles in the external service on your own).</p>

<p>Alternatively you can set up your own PIDs service based on the ARCHE Suite repository
metadata.
For that you just need a dedicated (sub)domain and a deployment of the
<a href="https://github.com/acdh-oeaw/arche-resolver/">arche-resolver</a> module.
The <code class="language-plaintext highlighter-rouge">arche-resolver</code> will also allow you to provide users with the content type negotation,
e.g. redirect them to a service converting the resource as it is stored in the repository
to another format.</p>

<p>Let’s try (deploying the resolver module within the arche-core Docker container
like we did for the OAI-PMH):</p>

<ul>
  <li>Choose a domain for your PIDs.
Here we will use th <code class="language-plaintext highlighter-rouge">my.pid</code>.
    <ul>
      <li>For the local testing define it as pointing to the <code class="language-plaintext highlighter-rouge">127.0.0.1</code> in the <code class="language-plaintext highlighter-rouge">/etc/hosts</code>
just like we did at the very beginning for the <code class="language-plaintext highlighter-rouge">my.domain</code>:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>...<span class="o">)</span>
127.0.0.1 my.pid
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Add <code class="language-plaintext highlighter-rouge">acdh-oeaw/arche-resolver</code> to the packages list in <code class="language-plaintext highlighter-rouge">arche-docker-config/composer.json</code>:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"acdh-oeaw/arche-core"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"zozlak/yaml-merge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"acdh-oeaw/arche-oaipmh"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"acdh-oeaw/arche-resolver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>Create the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/resolver.yaml</code> file containing the resolver module config
(consider reading comments provided in the code below):
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">schema</span><span class="pi">:</span>
  <span class="c1"># This section defines RDF properties used to describe dissemination services.</span>
  <span class="c1"># Here we just reuse the same settings we use at our OEAW deployment.</span>
  <span class="c1"># See https://acdh-oeaw.github.io/arche-docs/aux/dissemination_services.html</span>
  <span class="c1"># for details.</span>
  <span class="na">dissService</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#DisseminationService</span>
    <span class="na">location</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#serviceLocation</span>
    <span class="na">returnFormat</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#hasReturnType</span>
    <span class="na">matchProperty</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#matchesProp</span>
    <span class="na">matchValue</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#matchesValue</span>
    <span class="na">matchRequired</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#isRequired</span>
    <span class="na">revProxy</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#serviceRevProxy</span>
    <span class="na">parameterClass</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#DisseminationServiceParameter</span>
    <span class="na">parameterDefaultValue</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#hasDefaultValue</span>
    <span class="na">parameterRdfProperty</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#usesRdfProperty</span>
    <span class="na">hasService</span><span class="pi">:</span> <span class="s">https://vocabs.acdh.oeaw.ac.at/schema#hasDissService</span>
<span class="na">resolver</span><span class="pi">:</span>
  <span class="na">logging</span><span class="pi">:</span>
    <span class="na">file</span><span class="pi">:</span> <span class="s">/home/www-data/log/resolver.log</span>
    <span class="na">level</span><span class="pi">:</span> <span class="s">warning</span>
  <span class="na">idProtocol</span><span class="pi">:</span> <span class="s">http</span>
  <span class="na">idHost</span><span class="pi">:</span> <span class="s">my.pid</span>
  <span class="na">idPathBase</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
  <span class="na">defaultDissService</span><span class="pi">:</span> <span class="s">raw</span>
  <span class="c1"># quick redirects for dissemination formats provided by the arche-core</span>
  <span class="na">fastTrack</span><span class="pi">:</span>
    <span class="na">raw</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="s">application/octet-stream</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">rdf</span><span class="pi">:</span> <span class="s">/metadata</span>
    <span class="s">text/turtle</span><span class="pi">:</span> <span class="s">/metadata</span>
    <span class="s">application/n-triples</span><span class="pi">:</span> <span class="s">/metadata</span>
    <span class="s">application/rdf+xml</span><span class="pi">:</span> <span class="s">/metadata</span>
    <span class="s">application/ld+json</span><span class="pi">:</span> <span class="s">/metadata</span>
  <span class="na">repositories</span><span class="pi">:</span>
    <span class="c1"># the resolver is capable of searching against multiple arche-core</span>
    <span class="c1"># instances but we have only one so we set up only one</span>
    <span class="c1"># see https://github.com/acdh-oeaw/arche-docker-config/blob/arche/yaml/resolver.yaml</span>
    <span class="c1"># for a multi-repo setup</span>
    <span class="na">main</span><span class="pi">:</span>
      <span class="na">baseUrl</span><span class="pi">:</span> <span class="s">http://my.domain/api</span>
</code></pre></div>    </div>
  </li>
  <li>Create and <strong>make executable</strong> (<code class="language-plaintext highlighter-rouge">chmod +x arche-docker-config/run.d/resolver.sh</code>)
the <code class="language-plaintext highlighter-rouge">arche-docker-config/run.d/resolver.sh</code> file
initializing the resolver:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> /home/www-data/docroot/resolver <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'mkdir /home/www-data/docroot/resolver'</span>
  su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'ln -s /home/www-data/vendor /home/www-data/docroot/resolver/vendor'</span>
<span class="k">fi
</span>su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'cp /home/www-data/vendor/acdh-oeaw/arche-resolver/.htaccess /home/www-data/docroot/resolver/.htaccess'</span>
su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s1">'cp /home/www-data/vendor/acdh-oeaw/arche-resolver/index.php /home/www-data/docroot/resolver/index.php'</span>

<span class="c"># compile the final resolver config file from arche-docker-config/yaml/schema.yaml,</span>
<span class="c"># arche-docker-config/yaml/resolver.yaml and arche-docker-config/yaml/local.yaml</span>
<span class="nv">CMD</span><span class="o">=</span>/home/www-data/vendor/zozlak/yaml-merge/bin/yaml-edit.php
<span class="nv">CFGD</span><span class="o">=</span>/home/www-data/config/yaml
<span class="nb">rm</span> <span class="nt">-f</span> /home/www-data/docroot/resolver/config.yaml <span class="nv">$CFGD</span>/config-resolver.yaml
su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2"> --src </span><span class="nv">$CFGD</span><span class="s2">/schema.yaml --src </span><span class="nv">$CFGD</span><span class="s2">/resolver.yaml --src </span><span class="nv">$CFGD</span><span class="s2">/local.yaml </span><span class="nv">$CFGD</span><span class="s2">/config-resolver.yaml"</span>
su <span class="nt">-l</span> www-data <span class="nt">-c</span> <span class="s2">"ln -s </span><span class="nv">$CFGD</span><span class="s2">/config-resolver.yaml /home/www-data/docroot/resolver/config.yaml"</span>
</code></pre></div>    </div>
  </li>
  <li>Create the <code class="language-plaintext highlighter-rouge">arche-docker-config/sites-enabled/my.pid.conf</code> file
providing the webserver configuration for the my.pi domain:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    DocumentRoot /home/www-data/docroot/resolver
    ServerName my.pid

    &lt;Directory /home/www-data/docroot/resolver&gt;
        Options All
        AllowOverride All
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre></div>    </div>
  </li>
  <li>Restart the arche-core by hitting <code class="language-plaintext highlighter-rouge">CTRL+c</code> on the console where you run 
<code class="language-plaintext highlighter-rouge">docker compose up</code> and running <code class="language-plaintext highlighter-rouge">docker compose up</code> again.</li>
</ul>

<p>At this point we have the resolver service ready.
What we still need to do to make it useful is to assign our repository resources
identifiers in the my.pid domain:</p>

<ul>
  <li>Edit the <code class="language-plaintext highlighter-rouge">sampleData/metadata.ttl</code> adding <code class="language-plaintext highlighter-rouge">dc:identifier</code> triples
in the my.pid domain and setting read access rights to public
(we restricted them in our ACL experiments few chapters before), e.g.:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@prefix dc: &lt;http://purl.org/dc/terms/&gt;.
    &lt;http://id.namespace/collection1&gt; dc:title "Sample collection"@en ;
    dc:license "CC BY-NC" ;
    dc:identifier &lt;http://my.pid/collection1&gt; ;
    &lt;https://vocabs.acdh.oeaw.ac.at/schema#aclRead&gt; "public" .
&lt;http://id.namespace/Baedeker-Mittelmeer_1909.xml&gt; dc:title "Sample TEI-XML"@en ;
    dc:isPartOf &lt;http://id.namespace/collection1&gt; ;
    dc:license "CC BY-NC" ;
    dc:identifier &lt;http://my.pid/mittelmeer&gt; ;
    &lt;https://vocabs.acdh.oeaw.ac.at/schema#aclRead&gt; "public" .
</code></pre></div>    </div>
  </li>
  <li>Run a dedicated temporary docker container which we will use for the ingestion (it will have the sampleData directory availble under /data):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-ti</span> <span class="nt">--network</span> host <span class="nt">-v</span> ./sampleData:/data acdhch/arche-ingest
</code></pre></div>    </div>
  </li>
  <li>Reingest the metadata:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/arche-import-metadata /data/metadata.ttl http://my.domain/api admin ADMIN_PSWD_as_set_in_.env_file
</code></pre></div>    </div>
    <ul>
      <li>If you git an error, try looking at the logs in the <code class="language-plaintext highlighter-rouge">docs/rest.log</code></li>
    </ul>
  </li>
</ul>

<p>Now we should be able to play with the resolver
(we will user the <code class="language-plaintext highlighter-rouge">curl</code> so we can see what is going on in details
and are not affected by web browsers content negotation settings -
browsers always request response in <code class="language-plaintext highlighter-rouge">text/html</code>):</p>

<ul>
  <li>Resolve a resource using its identifier in the my.pid domain
(with the <code class="language-plaintext highlighter-rouge">-i</code> curl option we ask HTTP response headers to be displayed):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="s1">'http://my.pid/mittelmeer'</span>
</code></pre></div>    </div>
    <p>You should get something like:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 302 Found
(...)
Location: http://my.domain/api/2
(...)
</code></pre></div>    </div>
    <p>which means a resource has been found and you are redirected to
its actual location - http://my.domain/api/2</p>
  </li>
  <li>Let’s do the same asking the curl to follow the redirect (the <code class="language-plaintext highlighter-rouge">-L</code> option):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="s1">'http://my.pid/mittelmeer'</span>
</code></pre></div>    </div>
    <p>Now you should get the TEI-XML repository resource content.</p>
  </li>
  <li>Let’s try the content negotiation and request this resource in the
<code class="language-plaintext highlighter-rouge">application/n-triples</code> format:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="nt">-H</span> <span class="s1">'Accept: application/n-triples'</span> <span class="s1">'http://my.pid/mittelmeer'</span>
</code></pre></div>    </div>
    <p>Now you should get something like:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 302 Found
(...)
Location: http://my.domain/api/2/metadata
</code></pre></div>    </div>
    <p>As you can see the redirect location is different this time.
This is because we requested the repository resource to be
disseminated in a particular format (which is configured
in the resolver config - see the <code class="language-plaintext highlighter-rouge">resolver.fastTrack</code> section
of the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/resolver.yaml</code>).</p>
    <ul>
      <li>Let’s repeat asking curl to follow the redirect:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="nt">-H</span> <span class="s1">'Accept: application/n-triples'</span> <span class="s1">'http://my.pid/mittelmeer'</span>
</code></pre></div>        </div>
        <p>and we should get something like:</p>
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;http://my.domain/api/2&gt; &lt;http://purl.org/dc/terms/format&gt; "application/xml"  .
&lt;http://my.domain/api/2&gt; &lt;http://purl.org/dc/terms/created&gt; "2023-07-06T11:56:30.757867"^^&lt;http://www.w3.org/2001/XMLSchema#dateTime&gt;  .
(...)
&lt;http://my.domain/api/1&gt; &lt;http://purl.org/dc/terms/title&gt; "Sample collection"@en  .
(...)
</code></pre></div>        </div>
        <p>being metadata of the requested resource (as well as resources its metadata
directly point to, e.g. here the parent collection) in the <code class="language-plaintext highlighter-rouge">application/n-triples</code> format.</p>
      </li>
    </ul>
  </li>
  <li>As we set <code class="language-plaintext highlighter-rouge">resolver.defaultDissService</code> to <code class="language-plaintext highlighter-rouge">raw</code> in the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/resolver.yaml</code>,
requesting a not configured format will end up in <code class="language-plaintext highlighter-rouge">raw</code> which just redirects to
the resource’s repository URL:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="nt">-H</span> <span class="s1">'Accept: application/foo'</span> <span class="s1">'http://my.pid/mittelmeer'</span>
</code></pre></div>    </div>
    <p>should fetch:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 302 Found
(...)
Location: http://my.domain/api/2
(...)
</code></pre></div>    </div>
  </li>
  <li>Of course requesting an URL in the my.pid domain which does not correspond
to identifier of any repository resource will end up with HTTP 404 Not Found:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="s1">'http://my.pid/bar'</span>
</code></pre></div>    </div>
    <p>should result in something like:</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 404 Not Found
(...)
</code></pre></div>    </div>
  </li>
</ul>

<p>Summing up the nice thing about having the PIDs service is:</p>

<ul>
  <li>it can provide content negotation to the end user</li>
  <li>if you change the repository location, the only thing you need
to adjust to keep arche-resolver-managed PIDs being redirected
to the new repository location is to adjust
a single line in the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/resolver.yaml</code></li>
</ul>

<p>Closing remarks:</p>

<ul>
  <li>In this chapter only the “fast track” content negotation has been presented.
It is limited to just adding a suffix to the resource’s repository URL.
The arche-resolver provides far more powerful method of defining dissemination
services redirection rules but it is admittedly more complex.
You can read more about it <a href="dissemination_services.html">here</a>.</li>
</ul>

<h3 id="batch-updating-metadata">Batch-updating metadata</h3>

<p>From time to time you might want to perform a batch-update of the metadata.
The most common scenario are chagnes made in the metadata schema.</p>

<p>Performing such changes using the REST API is technically possible but very troublesome and time-consuming.
Instead of that you can directly access the metadata database and modify it using SQL queries.</p>

<p>Let’s say we want to change the RDF predicates used to store access control information:</p>

<ul>
  <li>turn <code class="language-plaintext highlighter-rouge">https://vocabs.acdh.oeaw.ac.at/schema#aclRead</code> into <code class="language-plaintext highlighter-rouge">acl://read</code></li>
  <li>turn <code class="language-plaintext highlighter-rouge">https://vocabs.acdh.oeaw.ac.at/schema#aclWrite</code> into <code class="language-plaintext highlighter-rouge">acl://write</code></li>
</ul>

<p>First, we modify the <code class="language-plaintext highlighter-rouge">accessControl.schema</code> settings in the <code class="language-plaintext highlighter-rouge">arche-docker-config/yaml/repo.yaml</code>
but this will only affect future interactions trought the REST API
so we have to update all already existing triples not to mess up everything.</p>

<p>Fortunately it’s pretty straigtforward:</p>

<ul>
  <li>As in this guide we are running the database in a separate Docker container called <code class="language-plaintext highlighter-rouge">postgresql</code>:
    <ul>
      <li>check the exact container name with <code class="language-plaintext highlighter-rouge">docker ps</code> - it will be the one with <code class="language-plaintext highlighter-rouge">postgresql</code> in name
(e.g. <code class="language-plaintext highlighter-rouge">tmp-postgresql-1</code> in my case)</li>
      <li>run <code class="language-plaintext highlighter-rouge">psql arch</code> inside of it with
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-ti</span> <span class="nt">-u</span> postgres tmp-postgresql-1 psql arche
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Update the metadata:
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">metadata</span> <span class="k">SET</span> <span class="n">property</span> <span class="o">=</span> <span class="s1">'acl://read'</span> <span class="k">WHERE</span> <span class="n">property</span> <span class="o">=</span> <span class="s1">'https://vocabs.acdh.oeaw.ac.at/schema#aclRead'</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">metadata</span> <span class="k">SET</span> <span class="n">property</span> <span class="o">=</span> <span class="s1">'acl://write'</span> <span class="k">WHERE</span> <span class="n">property</span> <span class="o">=</span> <span class="s1">'https://vocabs.acdh.oeaw.ac.at/schema#aclWrite'</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>Exit with
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\q
</code></pre></div>    </div>
  </li>
</ul>

<p>The direct database access can be also used to analyze the metadata, e.g.
quickly compute distribution of RDF predicated values, etc.:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">property</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">metadata</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">2</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div>

<p>A little more information on the database structure is provided <a href="https://github.com/acdh-oeaw/arche-core#database-structure">here</a>.</p>

<h2 id="further-considerations">Further considerations</h2>

<p>Congratulations, you completed your first dive into the ARCHE Suite world!</p>

<p>You managed to set up quite a range of services: the core repository module,
the OAI-PMH service, the PIDs resolver.
You managed to ingest a little data into the repository.
You played a little with the access control and metadata schema
and you also set up your very own metadata consistency check handler.</p>

<p>That being said in most cases we only touched a topic and there is still
a lot to discover (OAI-PMH templates, resolver’s dissemination services,
implementing your complete checks logic using handlers, dealing with
ARCHE Suites modules not mentioned in this guide, etc.).</p>

<p>Also, we have not touched at all the topic of your repository GUI
(explanation <a href="intro.html">here</a>).</p>

<p>You would surely benefit from some help dealing with all that missing stuff
so please do not hesitate to <a href="mailto:mzoltak@oeaw.ac.at">contact us</a>.</p>



      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/acdh-oeaw">acdh-oeaw</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/arche-docs/assets/js/scale.fix.js"></script>
  </body>
</html>
